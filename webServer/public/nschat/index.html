<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>nschat</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <style>
        .container{margin-top: 50px;}
        .log{height:300px;padding:20px;border:1px solid #179b16;overflow: auto;list-style: none}
        .log-name{display: block;padding:10px 0;font-size: 12px;color:#2c3e50;font-weight: 700;}
        .log-detail{display: block;padding:10px;border-radius:5px;}
        .log-other{background: #efefef}
        .log-self{background: dodgerblue;}
        .ipt{min-height:100px;}
        .record{border:1px solid #179b16;height:300px;}
    </style>
</head>
<body>
<h1 class="text-center">聊天室</h1>
<div class="container">
    <div class="row">
        <div class="col-xs-9">
            <ul class="log"></ul>
        </div>
        <div class="col-xs-3">
            <div class="record"></div>
        </div>
        <div class="col-xs-9">
            <div class="ipt" contenteditable="true" style="border:1px solid #2c3e50"></div>
            <button class="sendMsg">send</button>
        </div>
    </div>
</div>

<script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    $(function(){
        $('.ipt').focus();
        var socket = io.connect();  //连接服务器，触发connection事件
        var username;
        // 查询用户名
        $.ajax({
            url: '/user/userInfo',
            method: 'GET',
            success: function (userInfo) {
                if(userInfo == '400'){
                    console.log('未登录')
                }else{
                    username = userInfo;
                    socket.emit('_ENTER', username)
                }
            }
        });
        $('.sendMsg').on('click', function(){
            var newMsg = $('.ipt').html();
            console.log(newMsg);
            socket.emit('_SENDMSG', {   // 将该用户的聊天信息发送至服务器
                name: username,
                newMsg: newMsg
            });
        });
        // 监听enter事件，有人进入聊天室时触发
        socket.on('enter', function(data){
            console.log(data);
            $('.record').append('<p>欢迎 <span style="color:mediumvioletred;">' + data + '</span> !</p>')
        });
        // 监听用户退出事件
        socket.on('exit', function(data){
            $('.record').append('<p><span style="color:mediumvioletred;">' + data + '</span> 离开了!</p>')
        })
        // 监听消息更新，当有用户发送消息时触发
        socket.on('updateLog', function(data){
            var name = data.name;
            var msg = data.newMsg;
            if(name == username){
                name = '我';
                $('.log').append('<li><span class="log-name" style="text-align: right">'+name+' 说:</span><span class="log-detail log-self">'+msg+'</span></li>')
            }
            else{
                $('.log').append('<li><span class="log-name">'+name+' 说:</span><span class="log-detail log-other">'+msg+'</span></li>')
            }
        });
    })
</script>
</body>
</html>